# 双塔模型实践记录

## 负采样
- 一期：全国随机负采样，城市内随机采样
- 二期：不同城市10个，同城10个，再补充了同城的一些负样本 ，效果比一期略好一点
- 三期：不同城市的采样了20个，同城的随机采样5个 ，效果不好，同城之间的房源emb没有拉开
- 
- 四期：全国随机采样5个商圈，每个商圈采样5个。同城市不同商圈采样5个商圈，每个商圈采样20个。同城市同商圈采样5个 （hard）  效果很差：之前的负采样策略发现一个问题，除了全国负采样是easy样本以外，其他同城下，采样不同商圈本质上是把其他商圈的样本作为该用户的负样本，同商圈下，把其他用户没有点击的房源作为该用户的负样本，这样是错误的，相当于给该用户构造了很多假的负样本（或者说是hard样本），这些样本用户未必会不点击和浏览

- 五期：全国采样 n*5, 同城采样其他房源 5个 补充曝光未点击样本  效果不错


## 模型调参优化
- 是否需要在塔顶做归一化： 答案理论上是肯定的，但是auc在0.51左右 升不上去，先去掉L2_norm (work)
- 调大塔顶输出的emb_size 4->8->16->64,   发现emb_size增大，最后可视化的emb效果就越好
- 温度系数 0.1->0.01->0.001（work） 考虑是否通过学习的方式，让模型自适应一个温度系数，定义layer的方式，初始化一个权重作为温度系数，但是效果不佳，且不可控
- 底层embedding共享去掉，分开初始化（work auc->0.76）
- relu -> leakyRelu (work)
- 正则： L2， batch_norm, Dropout
- 固定学习率 -> 自适应学习率

## 模型特征优化
- 加入样本年龄，效果不明显
- bilstm抽取用户的访问序列特征  模型训练的难度增加，收敛较慢


## 模型结构优化
- base 双塔

![图](./pics/1.jpg)

- 双塔 （ResNet）

![图](./pics/4.jpg)

- 双塔 + SeNet

![图](./pics/2.jpg)

- 多兴趣SENet双塔模型 Multi-Interest-Senet-Two-Towers (MISTT)

![图](./pics/3.jpg)

- 腾讯并联双塔 （Parallel Towers）

![图](./pics/5.jpg)


![图](./pics/6.jpg)


### 模型于2022-02-15 909-58-零少AB测试上线
一、整体数据效果分析：
A组实验组，曝光数下降3～4k， 点击数基本不变， 因此点击率略有提升
B组对照组，曝光保持不变，点击数不变，点击率无明显变化

> question：但是点击率的提升真的是双塔召回带来的吗？

二、各路召回的数据效果分析：
1.模型上线，之前的各路策略在召回数量上有所减少，其中兴趣召回，通用召回, 商业召回 的召回数量下降明显，但点击率提升较为明显，其余几路召回的点击率变化不大
*原因是在合并多路去重时，会去score最大的作为召回策略，因此权重分数低的数量会相应减少
*其中商业召回，关系到收入，虽然曝光数有所降低，但点击数无明显变化，基本不影响收入

2.另外单独看双塔召回策略的效果：上线几日的点击率均值：0.31，高于商业召回和通用召回，从效果上看，单路的召回效果并不明显。
*在各路召回融合的时候，双塔召回引入了部分有效的召回，从而减少了一部分无效的召回（商业&通用）曝光给用户

> 分别看每个策略召回房源的与用户的匹配度

* 通用召回效果最差

* 除通用召回外 分2类：
第一类：规则类召回：零少命中小区，商业召回，兴趣召回，或多或少会限制一些信息（商圈，价格，面积，户型）
第二类：纯embedding召回，deepwalk，双塔

* 和deepwalk相比，召回的匹配度上，双塔均低于deepwalk，从各维度的数据上看，deepwalk的效果更好，因此双塔模型还需要继续优化

* 和其他召回相比：
1.面积匹配度：双塔优于通用召回
2.户型匹配度：双塔优于商业召回、命中小区召回、通用召回

结论：双塔在匹配度上整体低于deepwalk，其中商圈，面积，价格的匹配度上较低，因此后期优化上，需要考虑这几块特征的优化
分析原因：
一方面目前数量较少，负采样的比例可能过高，导致模型很难学习到正确的价格，面积，商圈等信息，有过拟合的风险
另一方面需要重新定义和刻画特征，使得模型更有效的学习

综合结论：模型上线后，对点击率有正向影响，并且商业的点击率有略微上升且点击量无明显变化（去除了部分无效的商业曝光），单路双塔模型上的效果只高于商业和通用的召回，从匹配度上看，召回的房源与用户偏好的面积和户型相对deepwalk更匹配，但在商圈和价格上匹配度不高，需要后期优化

# Embedding可视化效果
base双塔 + 规则负采样：

![图](./pics/7.jpeg)


base双塔 + 全国采样 n*5, 同城采样其他房源 5个 补充曝光未点击样本 

![图](./pics/8.png)


双塔 + SeNet

![图](./pics/9.jpeg)


双塔 + SeNet + 增加曝光未点击样本  增加到原来的1.5倍

![图](./pics/11.jpeg)

MISTT

![图](./pics/10.jpeg)


parallel Towers

![图](./pics/12.jpeg)

